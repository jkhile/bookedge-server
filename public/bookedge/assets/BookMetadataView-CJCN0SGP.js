import{d as te,r as c,m as L,x as ye,y as be,a as s,o as K,c as G,w as a,b as e,i as w,t as S,h as m,e as V,j as Ve,l as ge,z as ke,A as we,u as xe,g as Ce,B as Ie,C as Ue}from"./index-BmIoG3EC.js";import{l as J}from"./lodash-CMk6ASS6.js";import{_ as Be}from"./UnsavedChangesDialog.vue_vue_type_script_setup_true_lang-C1uZsk7D.js";import{u as Se}from"./use-books-NIUH2Quq.js";import{u as De}from"./use-imprints-hmX-DmGB.js";import{u as ze,E as le}from"./Editor-dK0HWANB.js";import{I as $e,u as Ne}from"./use-validation-rules-YCz6tJiF.js";import{_ as Ae}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ee=["colspan"],Re=te({__name:"FieldHistory",props:{showDialog:{type:Boolean},historyService:{},bookId:{},fieldPath:{}},emits:["close"],setup(Y,{emit:D}){const{currentUser:g}=Ve(),_=Y,R=D;let x=c([]);const h=[{text:"Date",key:"change_date"},{text:"By",key:"user_email"},{text:"Value",key:"value"}],f=L(()=>_.showDialog);return ye(async()=>{const z=be.service(_.historyService),p={$limit:5,fk_user:g.value.id,fk_book:_.bookId,path:_.fieldPath},C=await z.find({query:p});x.value=C.data}),(z,p)=>{const C=s("v-card-title"),$=s("v-card-text"),I=s("v-card"),T=s("v-data-table"),N=s("v-spacer"),A=s("v-btn"),U=s("v-card-actions"),y=s("v-dialog");return K(),G(y,{modelValue:f.value,"onUpdate:modelValue":p[1]||(p[1]=r=>f.value=r),"max-width":"800px"},{default:a(()=>[e(I,null,{default:a(()=>[e(C,null,{default:a(()=>[w("Revisions to "+S(_.fieldPath),1)]),_:1}),e($,null,{default:a(()=>[e(T,{headers:h,items:m(x),"show-expand":"","expand-on-click":"","items-per-page":5,density:"compact","data-cy":"history-table"},{"item.value":a(({value:r})=>[V("span",null,S(m(J.truncate)(r)),1)]),"expanded-row":a(({columns:r,item:b})=>[V("tr",null,[V("td",{colspan:r.length},[e(I,{color:"teal-lighten-5",flat:""},{default:a(()=>[e($,{class:"text-wrap"},{default:a(()=>[w(S(b.value),1)]),_:2},1024)]),_:2},1024)],8,Ee)])]),_:1},8,["items"])]),_:1}),e(U,null,{default:a(()=>[e(N),e(A,{class:"mb-4",text:"Close",color:"primary","data-cy":"close-history",onClick:p[0]||(p[0]=r=>R("close"))}),e(N)]),_:1})]),_:1})]),_:1},8,["modelValue"])}}}),he={class:"d-flex justify-end"},Te={class:"d-flex text-caption text-grey-darken-1 justify-end"},Pe={class:"d-flex justify-end"},je={class:"d-flex text-caption text-grey-darken-1 justify-end"},Me=te({__name:"BookMetadataView",setup(Y){const D=we(),g=xe(),{notifyInfo:_,notifyError:R}=Ue(),{requiredRule:x,accountingCodeRule:h,isbn13Rule:f}=Ne(),{getBook:z,emptyBook:p,saveBook:C,books:$}=Se(),{baseEditorInit:I}=ze(),{imprints:T,findImprints:N}=De(),A=c(void 0),U=c(!0),y=c(!1),r=c(""),b=c(!1),t=c(p()),O=c(null),P=c(!1),j=c(0),M=c(0);let Q="";const ae=["inactive","contract negotiation","contract signed","content editing","copy editing","print layout","proofing","pre-order","released"],oe=["Chinese","English","French","German","Korean","Russian"],ne=n=>t.value.derived_type==="original"||n?!0:`This field is required when Derived type is '${t.value.derived_type}'`,ue=n=>n!==0||"Please select an imprint",se={...I,setup:function(n){n.on("copy",function(l){var v;(v=l.clipboardData)==null||v.setData("text/plain",n.selection.getContent()),l.preventDefault()}),n.on("keyUP",function(){j.value=n.getContent().length}),n.on("init",function(){j.value=n.getContent().length})}},de={...I,setup:function(n){n.on("copy",function(l){var v;(v=l.clipboardData)==null||v.setData("text/plain",n.selection.getContent()),l.preventDefault()}),n.on("keyUP",function(){M.value=n.getContent().length}),n.on("init",function(){M.value=n.getContent().length})}},ie=L(()=>[{value:0,title:"Select an Imprint"},...T.value.map(n=>({value:n.id,title:n.imprint_name}))]),re=L(()=>$.value.filter(n=>n.id!==t.value.id).map(n=>({id:n.id,title:n.title})));ge(async()=>{if(U.value=!0,D.params.bookId==="new")t.value=p();else{const n=Number(D.params.bookId);t.value=await z(n)}O.value=J.cloneDeep(t.value),await N({}),U.value=!1,y.value=!1,r.value=""}),ke(n=>!y.value&&(!J.isEqual(t.value,O.value)||n.fullPath.includes("/books/new/"))?(r.value=n.name,b.value=!0,!1):!0);function k(n){Q=n,P.value=!0}const me=()=>{let n=t.value.keywords;n.includes(", ")?n=n.replace(/, /g,"; "):n.includes("; ")?n=n.replace(/; /g,","):n=n.replace(/[,;]/g,", "),t.value.keywords=n},E=n=>{const l=t.value[n],v=$e.asIsbn13(l,!l.includes("-"));t.value[n]=v};function ce(){b.value=!1,W(),g.push({name:r.value||"books-view"})}function pe(){b.value=!1,y.value=!0,Ie().then(()=>{g.push({name:r.value||"books-view"})})}async function W(){var l;const n=await A.value.validate();n.valid?(await C(t.value),y.value=!0,g.push({name:r.value||"books-view"}),_(`${(l=t.value)==null?void 0:l.title} saved`)):(document.querySelector(`#${n.errors[0].id}`).focus(),R("Check the form for errors and try saving again"))}function ve(){y.value=!0,g.push({name:"books-view"})}return(n,l)=>{const v=s("v-progress-linear"),d=s("v-text-field"),u=s("v-col"),B=s("v-select"),i=s("v-row"),_e=s("v-combobox"),q=s("v-textarea"),X=s("v-card-title"),Z=s("v-icon"),F=s("v-card-text"),H=s("v-card"),ee=s("v-btn"),fe=s("v-form");return U.value?(K(),G(v,{key:0,indeterminate:"",color:"primary"})):(K(),G(H,{key:1,title:"Add / Edit Book"},{default:a(()=>[e(F,null,{default:a(()=>[e(fe,{ref_key:"form",ref:A,"validate-on":"submit",density:"compact",onSubmit:Ce(W,["prevent"])},{default:a(()=>[e(i,null,{default:a(()=>[e(u,{cols:"10"},{default:a(()=>[e(d,{ref:"title",modelValue:t.value.title,"onUpdate:modelValue":l[0]||(l[0]=o=>t.value.title=o),label:"Title","append-inner-icon":"mdi-history",rules:[m(x)],density:"compact","data-cy":"title","onClick:appendInner":l[1]||(l[1]=o=>k("title"))},null,8,["modelValue","rules"])]),_:1}),e(u,{cols:"2"},{default:a(()=>[e(B,{modelValue:t.value.status,"onUpdate:modelValue":l[2]||(l[2]=o=>t.value.status=o),label:"Book status",items:ae,density:"compact","data-cy":"status"},null,8,["modelValue"])]),_:1})]),_:1}),e(i,null,{default:a(()=>[e(u,{cols:"6"},{default:a(()=>[e(_e,{modelValue:t.value.language,"onUpdate:modelValue":l[3]||(l[3]=o=>t.value.language=o),label:"Language",items:oe,density:"compact","data-cy":"language"},null,8,["modelValue"])]),_:1}),e(u,{cols:"6"},{default:a(()=>[e(d,{modelValue:t.value.accounting_code,"onUpdate:modelValue":l[4]||(l[4]=o=>t.value.accounting_code=o),label:"Accounting code",rules:[m(x),m(h)],hint:"E.g. ABC-01 Book Name",density:"compact","data-cy":"accounting_code"},null,8,["modelValue","rules"])]),_:1})]),_:1}),e(i,null,{default:a(()=>[e(u,{cols:"3"},{default:a(()=>[e(d,{modelValue:t.value.isbn_paperback,"onUpdate:modelValue":l[5]||(l[5]=o=>t.value.isbn_paperback=o),label:"ISBN paperback","append-inner-icon":"mdi-rotate-3d-variant",rules:[m(f)],density:"compact","data-cy":"isbn_paperback","onClick:appendInner":l[6]||(l[6]=o=>E("isbn_paperback"))},null,8,["modelValue","rules"])]),_:1}),e(u,{cols:"3"},{default:a(()=>[e(d,{modelValue:t.value.isbn_hardcover,"onUpdate:modelValue":l[7]||(l[7]=o=>t.value.isbn_hardcover=o),label:"ISBN hardcover","append-inner-icon":"mdi-rotate-3d-variant",rules:[m(f)],density:"compact","data-cy":"isbn_hardcover","onClick:appendInner":l[8]||(l[8]=o=>E("isbn_hardcover"))},null,8,["modelValue","rules"])]),_:1}),e(u,{cols:"3"},{default:a(()=>[e(d,{modelValue:t.value.isbn_epub,"onUpdate:modelValue":l[9]||(l[9]=o=>t.value.isbn_epub=o),label:"ISBN epub","append-inner-icon":"mdi-rotate-3d-variant",density:"compact",rules:[m(f)],"data-cy":"isbn_epub","onClick:appendInner":l[10]||(l[10]=o=>E("isbn_epub"))},null,8,["modelValue","rules"])]),_:1}),e(u,{cols:"3"},{default:a(()=>[e(d,{modelValue:t.value.isbn_ibooks,"onUpdate:modelValue":l[11]||(l[11]=o=>t.value.isbn_ibooks=o),label:"ISBN ibooks","append-inner-icon":"mdi-rotate-3d-variant",rules:[m(f)],density:"compact","data-cy":"isbn_ibooks","onClick:appendInner":l[12]||(l[12]=o=>E("isbn_ibooks"))},null,8,["modelValue","rules"])]),_:1})]),_:1}),e(i,null,{default:a(()=>[e(u,{cols:"12"},{default:a(()=>[e(B,{modelValue:t.value.fk_imprint,"onUpdate:modelValue":l[13]||(l[13]=o=>t.value.fk_imprint=o),label:"Imprint",items:ie.value,rules:[ue],density:"compact","data-cy":"imprint"},null,8,["modelValue","items","rules"])]),_:1})]),_:1}),e(i,null,{default:a(()=>[e(u,{cols:"12"},{default:a(()=>[e(q,{modelValue:t.value.subtitle,"onUpdate:modelValue":l[14]||(l[14]=o=>t.value.subtitle=o),label:"Subtitle","append-inner-icon":"mdi-history",rows:"2","auto-grow":"",counter:"","persistent-counter":"",density:"compact","data-cy":"subtitle","onClick:appendInner":l[15]||(l[15]=o=>k("subtitle"))},null,8,["modelValue"])]),_:1})]),_:1}),e(i,null,{default:a(()=>[e(u,{cols:"6"},{default:a(()=>[e(d,{modelValue:t.value.bisac_code_1,"onUpdate:modelValue":l[16]||(l[16]=o=>t.value.bisac_code_1=o),label:"BISAC Code 1",density:"compact","data-cy":"bisac_code_1"},null,8,["modelValue"])]),_:1}),e(u,{cols:"6"},{default:a(()=>[e(d,{modelValue:t.value.bisac_name_1,"onUpdate:modelValue":l[17]||(l[17]=o=>t.value.bisac_name_1=o),label:"BISAC Name 1",density:"compact","data-cy":"bisac_name_1"},null,8,["modelValue"])]),_:1})]),_:1}),e(i,null,{default:a(()=>[e(u,{cols:"6"},{default:a(()=>[e(d,{modelValue:t.value.bisac_code_2,"onUpdate:modelValue":l[18]||(l[18]=o=>t.value.bisac_code_2=o),label:"BISAC Code 2",density:"compact","data-cy":"bisac_code_2"},null,8,["modelValue"])]),_:1}),e(u,{cols:"6"},{default:a(()=>[e(d,{modelValue:t.value.bisac_name_2,"onUpdate:modelValue":l[19]||(l[19]=o=>t.value.bisac_name_2=o),label:"BISAC Name 2",density:"compact","data-cy":"bisac_name_2"},null,8,["modelValue"])]),_:1})]),_:1}),e(i,null,{default:a(()=>[e(u,{cols:"6"},{default:a(()=>[e(d,{modelValue:t.value.bisac_code_3,"onUpdate:modelValue":l[20]||(l[20]=o=>t.value.bisac_code_3=o),label:"BISAC Code 3",density:"compact","data-cy":"bisac_code_3"},null,8,["modelValue"])]),_:1}),e(u,{cols:"6"},{default:a(()=>[e(d,{modelValue:t.value.bisac_name_3,"onUpdate:modelValue":l[21]||(l[21]=o=>t.value.bisac_name_3=o),label:"BISAC Name 3",density:"compact","data-cy":"bisac_name_3"},null,8,["modelValue"])]),_:1})]),_:1}),e(i,null,{default:a(()=>[e(u,{cols:"12"},{default:a(()=>[e(H,{class:"mb-5 bg-grey-lighten-4","min-width":"100%"},{default:a(()=>[e(X,{class:"text-caption text-grey-darken-1"},{default:a(()=>[w("Short Description")]),_:1}),e(F,{width:"100%"},{default:a(()=>[e(m(le),{modelValue:t.value.short_description,"onUpdate:modelValue":l[23]||(l[23]=o=>t.value.short_description=o),"api-key":"9niojaiuexw4ihh7nlsmoewnzlmwvs1u1s5szorzvugzv0s7",init:{...se},"data-cy":"short_description"},{default:a(()=>[e(u,{cols:"1"},{default:a(()=>[V("span",he,[e(Z,{onClick:l[22]||(l[22]=o=>k("short_description"))},{default:a(()=>[w("mdi-history")]),_:1})]),V("span",Te,S(j.value)+" / 250",1)]),_:1})]),_:1},8,["modelValue","init"])]),_:1})]),_:1})]),_:1})]),_:1}),e(i,null,{default:a(()=>[e(u,{cols:"12"},{default:a(()=>[e(H,{class:"mb-5 bg-grey-lighten-4","min-width":"100%"},{default:a(()=>[e(X,{class:"text-caption text-grey-darken-1"},{default:a(()=>[w("Long Description")]),_:1}),e(F,{width:"100%"},{default:a(()=>[e(i,null,{default:a(()=>[e(u,{cols:"11"},{default:a(()=>[e(m(le),{modelValue:t.value.long_description,"onUpdate:modelValue":l[24]||(l[24]=o=>t.value.long_description=o),"api-key":"9niojaiuexw4ihh7nlsmoewnzlmwvs1u1s5szorzvugzv0s7",init:{...de},"data-cy":"long_description"},null,8,["modelValue","init"])]),_:1}),e(u,{cols:"1"},{default:a(()=>[V("span",Pe,[e(Z,{onClick:l[25]||(l[25]=o=>k("long_description"))},{default:a(()=>[w("mdi-history")]),_:1})]),V("span",je,S(M.value)+" / 4000",1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(i,null,{default:a(()=>[e(u,{cols:"6"},{default:a(()=>[e(B,{modelValue:t.value.derived_type,"onUpdate:modelValue":l[26]||(l[26]=o=>t.value.derived_type=o),label:"Derived type",items:["original","revision","edition","customization"],density:"compact","data-cy":"derived_type"},null,8,["modelValue"])]),_:1}),e(u,{cols:"6"},{default:a(()=>[e(B,{modelValue:t.value.fk_derived_from,"onUpdate:modelValue":l[27]||(l[27]=o=>t.value.fk_derived_from=o),disabled:t.value.derived_type==="original",label:"Derived from",items:re.value,"item-title":"title","item-value":"id",rules:[ne],density:"compact","data-cy":"fk_derived_from"},null,8,["modelValue","disabled","items","rules"])]),_:1})]),_:1}),e(i,null,{default:a(()=>[e(u,{cols:"12"},{default:a(()=>[e(q,{modelValue:t.value.keywords,"onUpdate:modelValue":l[28]||(l[28]=o=>t.value.keywords=o),label:"Keywords",rows:"1","auto-grow":"",counter:"","persistent-counter":"","append-icon":"mdi-rotate-3d-variant","append-inner-icon":"mdi-history","data-cy":"keywords",density:"compact","onClick:append":me,"onClick:appendInner":l[29]||(l[29]=o=>k("keywords"))},null,8,["modelValue"])]),_:1})]),_:1}),e(i,null,{default:a(()=>[e(u,{cols:"10"},{default:a(()=>[e(d,{modelValue:t.value.edition_name,"onUpdate:modelValue":l[30]||(l[30]=o=>t.value.edition_name=o),label:"Edition Name",density:"compact","data-cy":"edtion_name"},null,8,["modelValue"])]),_:1}),e(u,{cols:"2"},{default:a(()=>[e(d,{modelValue:t.value.edition_number,"onUpdate:modelValue":l[31]||(l[31]=o=>t.value.edition_number=o),modelModifiers:{number:!0},label:"Edition Number",type:"number",density:"compact","data-cy":"edition_number"},null,8,["modelValue"])]),_:1})]),_:1}),e(i,null,{default:a(()=>[e(u,{cols:"10"},{default:a(()=>[e(d,{modelValue:t.value.series_name,"onUpdate:modelValue":l[32]||(l[32]=o=>t.value.series_name=o),label:"Series Name",density:"compact","data-cy":"series_name"},null,8,["modelValue"])]),_:1}),e(u,{cols:"2"},{default:a(()=>[e(d,{modelValue:t.value.series_number,"onUpdate:modelValue":l[33]||(l[33]=o=>t.value.series_number=o),modelModifiers:{number:!0},label:"Series Number",type:"number",density:"compact","data-cy":"series_number"},null,8,["modelValue"])]),_:1})]),_:1}),e(i,null,{default:a(()=>[e(u,{cols:"12"},{default:a(()=>[e(B,{modelValue:t.value.audience,"onUpdate:modelValue":l[34]||(l[34]=o=>t.value.audience=o),label:"Audience",items:["Trade/General (Adult)","Young Adult (Child 13-18)","Juvenile (Child 0-12)","College (Textbook)","Elementary/High School (Textbook)","Professional/Scholar (Adult)"],density:"compact","data-cy":"audience"},null,8,["modelValue","items"])]),_:1})]),_:1}),e(i,null,{default:a(()=>[e(u,{cols:"12"},{default:a(()=>[e(d,{modelValue:t.value.thema,"onUpdate:modelValue":l[35]||(l[35]=o=>t.value.thema=o),label:"Thema",density:"compact","data-cy":"thema"},null,8,["modelValue"])]),_:1})]),_:1}),e(i,null,{default:a(()=>[e(u,{cols:"4"},{default:a(()=>[e(d,{modelValue:t.value.amazon_category_1,"onUpdate:modelValue":l[36]||(l[36]=o=>t.value.amazon_category_1=o),label:"Amazon category 1",density:"compact","data-cy":"amazon_category_1"},null,8,["modelValue"])]),_:1}),e(u,{cols:"4"},{default:a(()=>[e(d,{modelValue:t.value.amazon_category_2,"onUpdate:modelValue":l[37]||(l[37]=o=>t.value.amazon_category_2=o),label:"Amazon category 2",density:"compact","data-cy":"amazon_category_2"},null,8,["modelValue"])]),_:1}),e(u,{cols:"4"},{default:a(()=>[e(d,{modelValue:t.value.amazon_category_3,"onUpdate:modelValue":l[38]||(l[38]=o=>t.value.amazon_category_3=o),label:"Amazon category 3",density:"compact","data-cy":"amazon_category_3"},null,8,["modelValue"])]),_:1})]),_:1}),e(i,null,{default:a(()=>[e(u,{cols:"12"},{default:a(()=>[e(q,{modelValue:t.value.notes,"onUpdate:modelValue":l[39]||(l[39]=o=>t.value.notes=o),label:"Notes",rows:"2","auto-grow":"",counter:"","append-inner-icon":"mdi-history","data-cy":"notes",density:"compact","onClick:appendInner":l[40]||(l[40]=o=>k("notes"))},null,8,["modelValue"])]),_:1})]),_:1}),e(i,null,{default:a(()=>[e(u,{cols:"12"}),e(ee,{type:"submit",text:"Save",color:"primary",size:"small","data-cy":"save-book"}),e(ee,{class:"ml-4",text:"Cancel",size:"small","data-cy":"cancel-book",onClick:ve})]),_:1})]),_:1},512),e(Re,{"show-dialog":P.value,"history-service":"books-history","book-id":t.value.id,"field-path":m(Q),onClose:l[41]||(l[41]=o=>P.value=!1)},null,8,["show-dialog","book-id","field-path"]),e(Be,{show:b.value,"item-name":"book",onSave:ce,onDontSave:pe,onCancelled:l[42]||(l[42]=o=>b.value=!1)},null,8,["show"])]),_:1})]),_:1}))}}}),Oe=Ae(Me,[["__scopeId","data-v-7f4285a7"]]);export{Oe as default};
